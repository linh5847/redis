- name: Install Linux system packages
  yum:
    name: ["gcc", "libffi-devel", "libcurl-devel", "zlib-devel", "readline-devel", "ncurses-devel", "wget", "telnet", "net-tools"]
    state: "{{ state }}"

- name: Disable Linux firewalld.
  service:
    name: firewalld
    state: stopped
    enabled: no

- name: Set SELinux to disable mode.
  selinux:
    policy: targeted
    state: disabled

- name: Set SELinux to disable mode in the config file.
  lineinfile:
    path: "/etc/selinux/config"
    state: "{{ state }}"
    regexp: '^SELINUX=((.*))?'
    line: 'SELINUX=disabled'

- name: Disable hugepage.
  command: "echo never > /sys/kernel/mm/transparent_hugepage/enabled"
  run_once: true

- name: Deploy redis-sysctl config file to tune Linux kernel parameters.
  copy:
    src: files/redis-sysctl.conf
    dest: /etc/sysctl.d/redis-sysctl.conf
    owner: "{{ owner }}"
    group: "{{ group }}"
    mode: "{{ fmode }}"

- name: Enable Linux sysctl kernel parameters.
  command: "sysctl --system"
  run_once: true

- name: Install EPEL Repo.
  yum:
    name: ["epel-release", "yum-utils"]
    state: "{{ state }}"

- name: Install Redis Repo.
  yum:
    name: "http://rpms.remirepo.net/enterprise/remi-release-7.rpm"
    state: "{{ state }}"

- name: Configure and update Repo.
  command: "yum-config-manager --enable remi && yum repolist enabled"
  run_once: true

- name: Install redis package.
  yum:
    name: redis
    state: "{{ state }}"

- name: Create Redis cluster directories.
  file:
    path: "/etc/redis/cluster"
    state: "{{ dstate }}"
    owner: "{{ owner }}"
    group: "{{ group }}"
  register: pdir

- name: Create Redis Cluster Master directory.
  file:
    path: "{{ pdir.path }}/{{ master_port }}"
    state: "{{ dstate }}"
    owner: "{{ user_owner }}"
    group: "{{ user_group }}"

- name: Deploy Redis configure file.
  template:
    src: "redis_{{ master_port }}.conf.j2"
    dest: "{{ pdir.path }}/{{ master_port }}/redis_{{ master_port }}.conf"
    owner: "{{ user_owner }}"
    group: "{{ user_group }}"
    mode: "{{ fmode }}"

- name: Create Redis claster Master data directory.
  file:
    path: "/var/lib/redis/{{ master_port }}"
    state: "{{ dstate }}"
    owner: "{{ user_owner }}"
    group: "{{ user_group }}"

- name: Deploy Redis systemd service configure file.
  template:
    src: "redis_{{ master_port }}.service.j2"
    dest: "/etc/systemd/system/redis_{{ master_port }}.service"
    owner: "{{ owner }}"
    group: "{{ group }}"
    mode: "{{ fmode }}"

- name: Redis service enabled.
  service:
    name: "redis_{{ master_port }}.service"
    enabled: yes

- name: Enable systemd.
  systemd:
    daemon_reload: yes

- name: Startup Redis service daemon.
  service:
    name: "redis_{{ master_port }}.service"
    state: started

- name: Create Redis Cluster Slave directory.
  file:
    path: "{{ pdir.path }}/{{ slave_port }}"
    state: "{{ dstate }}"
    owner: "{{ user_owner }}"
    group: "{{ user_group }}"

- name: Deploy Redis configure file.
  template:
    src: "redis_{{ slave_port }}.conf.j2"
    dest: "{{ pdir.path }}/{{ slave_port }}/redis_{{ slave_port }}.conf"
    owner: "{{ user_owner }}"
    group: "{{ user_group }}"
    mode: "{{ fmode }}"

- name: Create Redis claster Slave data directory.
  file:
    path: "/var/lib/redis/{{ slave_port }}"
    state: "{{ dstate }}"
    owner: "{{ user_owner }}"
    group: "{{ user_group }}"

- name: Deploy Redis systemd service configure file.
  template:
    src: "redis_{{ slave_port }}.service.j2"
    dest: "/etc/systemd/system/redis_{{ slave_port }}.service"
    owner: "{{ owner }}"
    group: "{{ group }}"
    mode: "{{ fmode }}"

- name: Redis service enabled.
  service:
    name: "redis_{{ slave_port }}.service"
    enabled: yes

- name: Enable systemd.
  systemd:
    daemon_reload: yes

- name: Startup Redis service daemon.
  service:
    name: "redis_{{ slave_port }}.service"
    state: started

- name: Get Redis node1 IP address.
  local_action: "copy content='node1ip: {{ ansible_all_ipv4_addresses[1] }}' dest=file/node1ip"
  delegate_to: localhost
  when: inventory_hostname in groups['redis_node1']

- name: Get Redis node2 IP address.
  local_action: "copy content='node2ip: {{ ansible_all_ipv4_addresses[1] }}' dest=file/node2ip"
  delegate_to: localhost
  when: inventory_hostname in groups['redis_node2']

- name: Get Redis node3 IP address.
  local_action: "copy content='node3ip: {{ ansible_all_ipv4_addresses[1] }}' dest=file/node3ip"
  delegate_to: localhost
  when: inventory_hostname in groups['redis_node3']

- name: merge info in a variable file.
  assemble:
    src: file
    dest: "myip"
    mode: "{{ fmode }}"
  delegate_to: localhost

- name: Deploy output ip address of each to variable file.
  copy:
    src: "myip"
    dest: "roles/redis_cluster/defaults/main.yml"
    owner: "{{ lookup('env', 'USER') }}"
    group: "{{ lookup('env', 'USER') }}"
    mode: "{{ fmode }}"
  delegate_to: localhost

- name: cleanUp temp variable.
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - "myip"
    - file/node1ip
    - file/node2ip
    - file/node3ip
  delegate_to: localhost

- name: Create Redis cluster.
  shell: >
    redis-cli --cluster create "{{ node1ip }}:{{ master_port }}" "{{ node2ip }}:{{ master_port }}" "{{ node3ip }}:{{ master_port }}" "{{ node1ip }}:{{ slave_port }}" "{{ node2ip }}:{{ slave_port }}" "{{ node3ip }}:{{ slave_port }}" --cluster-replicas 1 > redis_cluster.log
  register: redis_cluster
  args:
    executable: /bin/bash
    creates: redis_cluster.log

- debug:
    msg: "{{ redis_cluster.stdout }}"